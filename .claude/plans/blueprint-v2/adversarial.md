# Blueprint v2: Adversarial Findings

> Generated by: Three-round debate chain (Challenger → Defender → Judge)
> Date: 2026-02-07
> Mode: debate
> Verdict: **REGRESS** — needs targeted fixes before implementation

## Summary

- **Critical:** 3
- **High:** 5
- **Medium:** 7
- **Low:** 5
- **Dropped (false):** 3 (manifest unbounded growth, debate log confusion, regression log unbounded)

---

## Critical

### C1. Regression Loop Prevention Missing
**Convergence:** both-agreed
**Issue:** Confidence threshold (0.5) + automatic regression triggers + 3-regression limit creates a HALT state where the system cannot proceed or regress. No defined recovery path.
**Fix:** Add explicit HALT state to state.json with status `"halted"`. When regression limit reached with confidence still <0.5, prompt: "[1] Override confidence threshold, [2] Simplify scope and restart, [3] Abandon blueprint."

### C2. No Enforcement Mechanism for "Mandatory" Empirica Calls
**Convergence:** both-agreed
**Issue:** Spec declares Empirica calls "MANDATORY" but enforcement is markdown instructions only. Agent will skip calls under token pressure. Confidence scoring and regression triggers fail silently.
**Fix:** Create `hooks/blueprint-stage-gate.sh` that checks for Empirica session_id in state.json before allowing stage transitions. Block if missing.

### C3. No Validation Strategy for 37+ File Global Rename
**Convergence:** both-agreed
**Issue:** W2 involves mechanical rename across 37+ files with no automated verification. Missed references break workflow invocation or accidentally invoke native plan mode.
**Fix:** Create validation script that greps for `/plan\b` and `/plans\b` command references (excluding `.claude/plans/` paths). Add to W2 acceptance criteria: zero command reference violations.

---

## High

### H1. Empirica Session ID Lost Across Conversation Boundaries
**Convergence:** both-agreed
**Issue:** Empirica session_id stored only in manifest.json. May not survive `memory_compact` or conversation restart. POSTFLIGHT cannot calculate learning delta.
**Fix:** Store session_id in BOTH manifest.json AND state.json. Explicitly include in checkpoint and memory_compact handoff. If lost on resume, create continuation session and log discontinuity.

### H2. No Schema Validation for Debate/Pre-Mortem Output
**Convergence:** both-agreed
**Issue:** Debate Judge and Pre-mortem outputs feed automatic regression triggers but have no schema enforcement. Malformed output causes silent trigger failures.
**Fix:** Define JSON output schema for debate rounds (required: finding, severity, convergence, addressed). If schema validation fails, fall back to vanilla mode output with all findings at medium severity.

### H3. Work Graph Staleness After Regression Not Explicit
**Convergence:** newly-identified (Defender nuanced)
**Issue:** Spec says "regression to Stage 2 handles" work graph updates but doesn't explicitly require regeneration. Stale graph fed to `/delegate` causes incorrect parallelization.
**Fix:** Add to regression behavior: When regressing to Stage 2, mark work-graph.json as stale. Stage 2 completion MUST regenerate it. Stale work graph blocks Stage 3 progression.

### H4. Parallelization Recommendation Ignores User Intent
**Convergence:** both-agreed
**Issue:** Recommendation based on structural metrics (width, critical path) not user intent. A quick prototype shouldn't get "strongly recommend /delegate".
**Fix:** Add `execution_preference` field to triage (Stage 1): `speed` / `simplicity` / `auto`. Update recommendation logic accordingly.

### H5. Manifest Write Failures Are Silent
**Convergence:** newly-identified
**Issue:** If manifest write fails (permissions, disk full), next resume loads stale data. No detection or recovery.
**Fix:** On write failure: set `"manifest_stale": true` in state.json, preserve `manifest.json.bak`, block stage progression until write succeeds. On resume: detect staleness flag and attempt regeneration from artifacts.

---

## Medium

### M1. Debate Mode Default Is Unproven
**Convergence:** both-agreed
**Issue:** Debate set as default without evidence it outperforms vanilla. ~6x token cost with no validation of value.
**Fix:** Default to `vanilla` for initial release. After 20+ blueprints, compare outcomes. Promote debate to default if ≥30% improvement in any metric.

### M2. Pre-Mortem Value Not Differentiated from Challenge + Edge Cases
**Convergence:** both-agreed
**Issue:** Pre-mortem asks "what could go wrong?" after two rounds of adversarial analysis already answered that. Unique value unclear.
**Fix:** Differentiate explicitly: Pre-mortem focuses on OPERATIONAL failures (deployment, monitoring, rollback, oncall) vs. Challenge/Edge Cases on DESIGN failures. If findings overlap >80% with prior stages, skip on future blueprints.

### M3. Work Graph and Spec Work Units Can Diverge
**Convergence:** both-agreed
**Issue:** work-graph.json generated from spec.md "Work Units" table but no sync verification. Manual spec edits cause divergence.
**Fix:** Add checksum to work-graph.json: hash of spec.md Work Units section. On Stage 7 entry, verify checksum. Mismatch blocks `/delegate` until regenerated.

### M4. No Fallback for Corrupted Manifest
**Convergence:** both-agreed
**Issue:** If manifest.json is corrupted (partial write, syntax error), all recovery points fail. No regeneration fallback.
**Fix:** On manifest read failure: attempt regeneration from describe.md + spec.md + adversarial.md + state.json. If regeneration succeeds, write manifest and continue. If fails, halt with error.

### M5. No Debate Timeout Protection
**Convergence:** newly-identified
**Issue:** 6 sequential subagent calls with no timeout. Hung subagent makes workflow unrecoverable.
**Fix:** 5-minute timeout per debate agent, 15 min per stage. On timeout: log deadend, fall back to vanilla for that stage, preserve completed rounds.

### M6. "Blueprint" vs ".claude/plans/" Naming Documented But Still Confusing
**Convergence:** disputed (Challenger: confusing, Defender: documented)
**Judge verdict:** Documentation doesn't eliminate confusion. Accept as backward-compat tradeoff.
**Fix:** Add FAQ to README explaining the naming gap. Consider symlink `.claude/blueprints → .claude/plans` if confusion persists.

### M7. No Migration Path for Pre-v2 Plans
**Convergence:** newly-identified
**Issue:** Existing plans lack new fields (challenge_mode, confidence, premortem, Empirica session). Resuming pre-v2 plan fails.
**Fix:** Add migration logic: detect missing `blueprint_version` in state.json → set defaults (challenge_mode="vanilla", premortem.status="skipped", revision=1) → generate manifest from existing artifacts → set version=2.

---

## Low

### L1. Pre-Mortem Regression May Reintroduce Resolved Ambiguity
**Convergence:** newly-identified
**Fix:** Append "Preserved resolutions" list to regression context when regressing from Pre-mortem.

### L2. No Manifest Staleness Detection
**Convergence:** both-agreed
**Fix:** Add `artifact_timestamps` to manifest. Compare on read. Warn if artifacts are newer than manifest.

### L3. LLMs Can't Self-Assess Confidence Accurately
**Convergence:** both-agreed
**Fix:** Make confidence advisory, not authoritative. Require BOTH low confidence AND a trigger event (critical finding, etc.) to suggest regression. Don't auto-trigger on confidence alone.

### L4. Multiple Representations of Findings (No Source of Truth)
**Convergence:** disputed → resolved
**Fix:** Declare adversarial.md as source of truth. Manifest digests are compressed indexes for recovery only. debate-log.md and premortem.md are supporting artifacts.

### L5. No Work Units Table Schema
**Convergence:** newly-identified
**Fix:** Define required columns: ID, Description, Files, Dependencies, Complexity. Add to Section 7.2.

---

## Dropped Findings (assessed as false)

- ~~Finding 4: Manifest grows unbounded~~ — FALSE. Manifest has fixed-size fields. Regression history stored separately in spec.diff.md.
- ~~Finding 12: Debate log vs curated findings confusion~~ — FALSE. Spec already disambiguates: adversarial.md is primary, debate-log.md is debug.
- ~~Finding 17: Regression log grows unbounded~~ — FALSE. Max 3 regressions = max 3 entries (~600 bytes).

---
---

# Revision 2 Re-validation Debate

> Generated by: Three-round debate chain (Challenger → Defender → Judge)
> Date: 2026-02-07
> Mode: debate (re-validation of Revision 2 spec)
> Verdict: **PASS_WITH_NOTES** — proceed to next stage with implementation guidance

## Summary

- **Critical:** 0
- **High:** 0
- **Medium:** 7
- **Low:** 8
- **Dropped (false/overstated):** 5 (stage numbering, work units enforcement, migration hook conflict, sonnet open question, token estimates)

All Revision 1 critical/high findings were confirmed as addressed.

---

## Medium

### F2. Debate Schema Fallback Parsing Underspecified
**Convergence:** both-agreed
**Issue:** H2 fix adds JSON schema validation with vanilla fallback on failure, but "vanilla mode output processing" for freeform markdown has no defined parsing strategy. Regression triggers can't process unstructured text.
**Fix:** On JSON parse failure: extract numbered list items via pattern matching (`F[0-9]+`, `[0-9]+.`, `-`). Assign all severity=medium, convergence=newly-identified. Flag for human review.

### F4. Manifest Regeneration Circular Dependency
**Convergence:** both-agreed
**Issue:** M4 fix assumes state.json is valid when manifest is corrupt, but both can fail from the same cause (disk/permissions).
**Fix:** Priority order: (1) regenerate from artifacts + state.json, (2) if state.json also corrupt, derive stage status from artifact file existence/timestamps, (3) if all fail, halt with explicit error listing missing files.

### F8. Pre-Mortem Overlap "80%" Has No Algorithm
**Convergence:** both-agreed
**Issue:** "If pre-mortem findings overlap >80% with prior stages" is unimplementable without an algorithm.
**Fix:** Semantic match: same failure category + same affected component = COVERED. If >80% marked COVERED, note `"premortem_overlap": "high"` in state.json.

### F9. "Flag as Blocking" Option Undefined
**Convergence:** both-agreed
**Issue:** Regression prompt option [3] has no defined behavior — what does "manually resolved" mean?
**Fix:** Set `status='blocked_pending_resolution'` in state.json. Append finding with [BLOCKING] tag to adversarial.md. Resume requires user resolution or explicit override.

### F15. HALT Confidence Check Includes Skipped Stages
**Convergence:** newly-identified (Defender)
**Issue:** HALT activates when confidence <0.5 "on any stage" but skipped stages have no confidence score. Undefined behavior.
**Fix:** Only check completed stages. Skipped stages excluded from threshold evaluation.

### F17. Checksum Mismatch Blocks /delegate But No Regeneration Process
**Convergence:** newly-identified (Defender)
**Issue:** Work graph checksum validation blocks `/delegate` on mismatch but doesn't define who regenerates or how.
**Fix:** Auto-regenerate work-graph.json from current spec.md Work Units on mismatch. If regeneration fails (malformed table), halt with error pointing to spec.

### F19. Challenge Mode Preservation Across Regressions
**Convergence:** newly-identified (Defender)
**Issue:** Spec doesn't explicitly state whether challenge_mode is preserved or re-selectable on regression.
**Fix:** Challenge mode preserved in state.json, locked per blueprint lifecycle. Re-running Stage 3/4 uses original mode.

---

## Low

### F3. Hook Write Atomicity Not Specified
**Convergence:** Defender downgraded (High → Low)
**Issue:** PostToolUse hook fires after Write completion so no race condition exists, but atomic Write semantics not explicitly stated.
**Fix:** Add note: "Hook fires PostToolUse, reading the completed write result."

### F5. Work Graph Staleness Text Error
**Convergence:** both-agreed (High → Low)
**Issue:** Copy-paste error: one location says "blocks Stage 3" instead of "Stage 7."
**Fix:** Change to "blocks Stage 7 progression (specifically `/delegate` consumption)."

### F6. Execution Preference Locked After Stage 1
**Convergence:** both-agreed (High → Low)
**Issue:** No way to update execution_preference after triage. But Stage 7 shows a recommendation, not enforcement.
**Fix:** Clarify: preference is advisory. User always has final choice at Stage 7 execution screen.

### F7. Debate Timeout Preserves Rounds (Clarification Only)
**Convergence:** Defender downgraded (Medium → Low)
**Issue:** Already addressed — spec says "preserve any completed rounds." Implementation detail.

### F10. PASS_WITH_NOTES Behavior Unspecified
**Convergence:** both-agreed
**Issue:** Verdict enum includes PASS_WITH_NOTES but no semantic definition.
**Fix:** PASS_WITH_NOTES = non-critical findings only, proceed normally, append findings to adversarial.md.

### F12. overrides.json Reference Dangling
**Convergence:** both-agreed
**Issue:** Section 4.4 references overrides.json which doesn't exist in the spec.
**Fix:** Remove reference or define minimally. Since it's referenced once in an escape hatch, removing is simpler.

### F14. Spec Diff Backup Mechanism Undefined
**Convergence:** both-agreed
**Issue:** No mechanism to preserve previous spec version for diffing after regression.
**Fix:** Copy spec.md to spec.md.revision-N.bak before allowing re-entry to Stage 2.

### F20. Team Mode Quality Gate Hooks Referenced But Undefined
**Convergence:** newly-identified (Defender)
**Issue:** TeammateIdle and TaskCompleted hooks referenced in Section 2.4 but never defined.
**Fix:** Already flagged as Open Question 3. Mark as deferred design decision.

---

## Dropped Findings (assessed as false/overstated)

- ~~F1: Stage numbering breaks~~ — FALSE. Spec explicitly says stages tracked by name, not number. "4.5" is human-readable label only.
- ~~F11: Work Units table columns not enforced~~ — OVERSTATED. Checksum validation (7.4) is the enforcement mechanism.
- ~~F13: Pre-v2 migration Empirica hook conflict~~ — FALSE. Hook is advisory (exit 0), warning by design.
- ~~F16: Sonnet mandate vs Open Question~~ — Documentation only. Open Question flags configurable future work; sonnet is the v1 default.
- ~~F18: Token budget unsupported estimates~~ — Non-blocking. Estimates are design justification, not contracts.

---
---

# Stage 4: Edge Case Analysis

> Generated by: Three-round debate chain (Boundary Explorer → Stress Tester → Synthesizer)
> Date: 2026-02-07
> Mode: debate
> Verdict: **NO REGRESSION REQUIRED** — all edge cases addressable as implementation-time fixes

## Summary

- **Must Fix:** 4 (implementation-time)
- **Should Fix:** 3 (implementation-time)
- **Document:** 2 (V2 limitations)
- **Already Handled:** 6 (by existing spec)
- **Trivial/Low Priority:** 6

Total boundaries mapped: 40+ across 5 categories (input, state, concurrency, time, scale)

---

## Must Fix (Critical/High — Implementation-Time)

### EC-1. Empty Work Units After Stage 2
**Category:** Input boundary
**Likelihood:** Uncommon | **Impact:** Critical
**Scenario:** User writes spec with no Work Units table, or table has only headers. Stage 7 (`/delegate`) receives empty dependency graph.
**Fix:** Validate Work Units count > 0 at Stage 2 completion. If zero, block progression with: "Spec requires at least one Work Unit. Add Work Units table to spec.md."
**Relevant WU:** W12, W13

### EC-2. Cold Start Bootstrap — First-Ever Blueprint
**Category:** State boundary
**Likelihood:** Common | **Impact:** Critical
**Scenario:** User runs `/blueprint my-feature` with no `.claude/plans/` directory, no prior blueprints, no Empirica project. Multiple initialization paths race.
**Fix:** Bootstrap sequence: (1) create `.claude/plans/` if missing, (2) create blueprint subdirectory, (3) initialize state.json with defaults, (4) create Empirica session, (5) proceed to Stage 1. Each step idempotent — check existence before creating.
**Relevant WU:** W1, W8, W11

### EC-3. Blueprint Name Collision
**Category:** Input boundary
**Likelihood:** Common | **Impact:** High
**Scenario:** User runs `/blueprint auth` when `.claude/plans/auth/` already exists with a completed blueprint. Ambiguous: create new? Resume? Overwrite?
**Fix:** On name collision: (1) check state.json status — if `execute.status === "complete"`, prompt "Blueprint 'auth' already complete. [1] Create 'auth-2', [2] View existing, [3] Archive and recreate." (2) If in-progress, resume from current stage. (3) Never silently overwrite.
**Relevant WU:** W1

### EC-4. Circular Dependencies in Work Graph
**Category:** Input boundary
**Likelihood:** Uncommon | **Impact:** Critical
**Scenario:** User writes Work Units with circular deps: W3→W5→W7→W3. `/delegate` enters infinite scheduling loop.
**Fix:** Add topological sort validation when generating work-graph.json. On cycle detection: (1) identify cycle members, (2) halt with error listing the cycle, (3) prompt user to fix dependency table in spec.md.
**Relevant WU:** W12, W13

---

## Should Fix (Medium/High — Implementation-Time)

### EC-5. Debate Timeout Double-Fault
**Category:** Time boundary
**Likelihood:** Rare | **Impact:** High
**Scenario:** Debate Round 1 (Challenger) times out at 5 min. Spec says fall back to vanilla. But vanilla processing ALSO times out (another 5 min). 15-minute stage timeout may or may not have been consumed.
**Fix:** Clarify cascading timeout behavior: stage timeout (15 min) is the outer envelope. If Round 1 times out, remaining time for fallback = stage_timeout - elapsed. If remaining < 2 min, skip stage entirely with `confidence: 0.3` and note "timeout, no adversarial review completed."
**Relevant WU:** W4

### EC-6. Interrupted Debate Mid-Round
**Category:** State boundary
**Likelihood:** Uncommon | **Impact:** Medium
**Scenario:** Conversation ends (context limit, user closes terminal) after Round 1 completes but before Round 2 starts. On resume, state.json says `challenge.status: "in_progress"` but no record of which round completed.
**Fix:** Track debate progress in state.json: `"debate_progress": { "rounds_completed": ["challenger"], "current_round": "defender" }`. On resume, skip completed rounds and continue from current_round.
**Relevant WU:** W4, W7

### EC-7. Asymmetric Empirica Session State
**Category:** State boundary
**Likelihood:** Uncommon | **Impact:** Medium
**Scenario:** Empirica session_id exists in state.json but not manifest.json (or vice versa) after a partial write failure. Hook enforcement checks one location, POSTFLIGHT reads the other.
**Fix:** On session_id mismatch: (1) prefer state.json as source of truth (simpler, less likely to corrupt), (2) sync to manifest.json, (3) log warning via Empirica `finding_log`. If both missing: create new session and log discontinuity.
**Relevant WU:** W11

---

## Document as V2 Limitations

### EC-8. Concurrent State Writes
**Category:** Concurrency boundary
**Likelihood:** Rare | **Impact:** Medium
**Scenario:** In team mode, two agents write state.json simultaneously (e.g., both completing stages). Last-write-wins causes data loss.
**Guidance:** Document as V2 limitation. Team mode is deferred (Open Question 3). Single-agent workflow assumed. Add to spec: "V2 assumes single-agent execution. Concurrent state access requires locking (deferred to V3)."

### EC-9. Scale Limits
**Category:** Scale boundary
**Likelihood:** Rare | **Impact:** Low
**Scenario:** Blueprint with 100+ Work Units, 50+ adversarial findings, 10+ debate rounds across regressions. Manifest exceeds practical size, token budgets blown.
**Guidance:** Document practical limits: "Recommended: ≤30 Work Units, ≤3 regressions. For larger scopes, decompose into multiple blueprints." Token budget estimates in spec are for typical (10-20 WU) blueprints.

---

## Already Handled by Existing Spec

| ID | Boundary | Why Handled |
|----|----------|-------------|
| EC-10 | Missing describe.md on Stage 2 entry | Stage gate hook blocks progression without prior artifacts |
| EC-11 | Invalid confidence values (negative, >1.0) | Schema validation in manifest + state.json |
| EC-12 | Regression from Stage 1 | Regression only triggers from Stage 3+ per spec 4.1 |
| EC-13 | Work graph with single node (no deps) | Valid — trivially satisfies topological sort |
| EC-14 | User skips all optional stages | Allowed — spec marks 3-6 as skippable, execute still reachable |
| EC-15 | Manifest with null fields | Schema defines all fields as required with defaults |

---

## Trivial / Low Priority

| ID | Boundary | Disposition |
|----|----------|-------------|
| EC-16 | Blueprint name with special chars | Sanitize to `[a-z0-9-]` on creation |
| EC-17 | Very long blueprint names (>255 chars) | Truncate to 64 chars with warning |
| EC-18 | Empty describe.md (user writes nothing) | Treat as incomplete — block Stage 2 entry |
| EC-19 | Spec.md with markdown rendering issues | Non-blocking — spec is machine-consumed |
| EC-20 | Debate agents return identical output | Valid — record as "full convergence" |
| EC-21 | Pre-v2 plan with corrupt state.json | Migration detects, applies fresh defaults |

---

## Synthesizer Recommendations (Spec Clarifications)

These are **additive clarifications** to handle during implementation. None require architectural changes.

| # | Clarification | Relevant WU |
|---|---------------|-------------|
| 1 | Add Work Units count validation at Stage 2 exit | W12 |
| 2 | Define bootstrap sequence for first-ever blueprint | W1 |
| 3 | Define name collision resolution behavior | W1 |
| 4 | Add cycle detection to work graph generation | W12, W13 |
| 5 | Clarify cascading timeout envelope for debate | W4 |
| 6 | Track debate round progress in state.json | W4, W7 |
| 7 | Define session_id mismatch resolution priority | W11 |
| 8 | Document V2 concurrency limitation | Spec addendum |
| 9 | Document recommended scale limits | Spec addendum |
